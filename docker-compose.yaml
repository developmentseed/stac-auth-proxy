services:
  stac-pg:
    profiles: [""] # default profile
    image: ghcr.io/stac-utils/stac-fastapi-pgstac:6.1.1
    environment:
      STAC_FASTAPI_TITLE: stac-fastapi-pgstac + stac-auth-proxy
      STAC_FASTAPI_DESCRIPTION: A STAC FastAPI implemented with pgSTAC, protected with STAC Auth Proxy
      APP_HOST: 0.0.0.0
      APP_PORT: 8001
      CORS_HEADERS: "*"
      RELOAD: true
      POSTGRES_USER: username
      POSTGRES_PASS: password
      POSTGRES_DBNAME: postgis
      POSTGRES_HOST_READER: database-pg
      POSTGRES_HOST_WRITER: database-pg
      POSTGRES_PORT: 5432
      DB_MIN_CONN_SIZE: 1
      DB_MAX_CONN_SIZE: 1
      USE_API_HYDRATE: ${USE_API_HYDRATE:-false}
    hostname: stac
    ports:
      - "8001:8001"
    depends_on:
      - database-pg
    command: python -m stac_fastapi.pgstac.app
    # command: bash -c "./scripts/wait-for-it.sh database-pg:5432 && python -m stac_fastapi.pgstac.app"

  stac-os:
    profiles: ["os"]
    container_name: stac-fastapi-os
    image: ghcr.io/stac-utils/stac-fastapi-os:v6.1.0
    environment:
      STAC_FASTAPI_TITLE: stac-fastapi-opensearch + stac-auth-proxy
      STAC_FASTAPI_DESCRIPTION: A STAC FastAPI with an Opensearch backend, protected with STAC Auth Proxy
      STAC_FASTAPI_LANDING_PAGE_ID: stac-fastapi-opensearch
      APP_HOST: 0.0.0.0
      APP_PORT: 8001
      RELOAD: true
      ENVIRONMENT: local
      ES_HOST: database-os
      ES_PORT: 9200
      ES_USE_SSL: false
      ES_VERIFY_CERTS: false
      BACKEND: opensearch
      STAC_FASTAPI_RATE_LIMIT: 200/minute
    hostname: stac
    ports:
      - "8001:8001"
    depends_on:
      - database-os
    command: |
      bash -c "./scripts/wait-for-it-es.sh database-os:9200 && python -m stac_fastapi.opensearch.app"

  database-pg:
    profiles: [""] # default profile
    container_name: database-pg
    image: ghcr.io/stac-utils/pgstac:v0.9.5
    environment:
      POSTGRES_USER: username
      POSTGRES_PASSWORD: password
      POSTGRES_DB: postgis
      PGUSER: username
      PGPASSWORD: password
      PGDATABASE: postgis
    ports:
      - "${MY_DOCKER_IP:-127.0.0.1}:5439:5432"
    command: postgres -N 500
    volumes:
      - ./.pgdata:/var/lib/postgresql/data

  database-os:
    profiles: ["os"]
    container_name: database-os
    image: opensearchproject/opensearch:${OPENSEARCH_VERSION:-2.11.1}
    hostname: database-os
    environment:
      cluster.name: stac-cluster
      node.name: os01
      http.port: 9200
      http.cors.allow-headers: X-Requested-With,Content-Type,Content-Length,Accept,Authorization
      discovery.type: single-node
      plugins.security.disabled: true
      OPENSEARCH_JAVA_OPTS: -Xms512m -Xmx512m
    ports:
      - "9200:9200"

  proxy:
    depends_on:
      - oidc
    build:
      context: .
    environment:
      UPSTREAM_URL: ${UPSTREAM_URL:-http://stac:8001}
      OIDC_DISCOVERY_URL: ${OIDC_DISCOVERY_URL:-http://localhost:8888/.well-known/openid-configuration}
      OIDC_DISCOVERY_INTERNAL_URL: ${OIDC_DISCOVERY_INTERNAL_URL:-http://oidc:8888/.well-known/openid-configuration}
      DEBUG: 1
    env_file:
      - path: .env
        required: false
    ports:
      - "8000:8000"
    volumes:
      - ./src:/app/src
    labels:
      # Traefik labels for the double-proxy profile
      - "traefik.enable=true"
      - "traefik.http.routers.stac-auth-proxy.rule=PathPrefix(`/stac`)"
      - "traefik.http.routers.stac-auth-proxy.entrypoints=web"
      - "traefik.http.services.stac-auth-proxy.loadbalancer.server.port=8000"
      # # Strip the /stac prefix before forwarding to the auth proxy

  oidc:
    image: ghcr.io/alukach/mock-oidc-server:latest
    environment:
      ISSUER: http://localhost:8888
      SCOPES: item:create,item:update,item:delete,collection:create,collection:update,collection:delete
      PORT: 8888
    ports:
      - "8888:8888"

  stac-browser:
    image: ghcr.io/radiantearth/stac-browser:latest
    ports:
      - 8080:8080
    environment:
      SB_catalogUrl: "http://localhost:8000"
      SB_authConfig: |
        {
          "type": "openIdConnect",
          "openIdConnectUrl": "http://localhost:8888/.well-known/openid-configuration",
          "oidcOptions": {
            "client_id": "stac-browser"
          }
        }

  traefik:
    profiles: ["double-proxy"]
    image: traefik:v3.2
    container_name: traefik
    command:
      # Enable the API and dashboard (accessible at http://localhost:8081)
      - "--api.insecure=true"
      - "--api.dashboard=true"
      # Configure the Docker provider
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      # Define the entrypoint
      - "--entrypoints.web.address=:80"
      # Enable access logs for debugging
      - "--accesslog=true"
      - "--log.level=DEBUG"
    ports:
      # Main HTTP entrypoint - this is where clients connect
      - "80:80"
      # Traefik dashboard
      - "8081:8080"
    volumes:
      # Mount the Docker socket so Traefik can discover services
      - /var/run/docker.sock:/var/run/docker.sock:ro
    depends_on:
      - proxy
